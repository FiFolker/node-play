<div class="skyjo-shell">
    <!-- Panel Gauche : Leaderboard Permanent -->
    <aside class="side-panel leaderboard">
        <div class="panel-header">
            <h3>Classement</h3>
            <span class="player-count">{{ sortedPlayers().length }} joueurs</span>
        </div>
        <div class="lb-list">
            @for (p of sortedPlayers(); track p.oderId; let i = $index) {
            <div class="lb-row" [class.me]="p.oderId === socketService.currentPlayer()?.id" [class.dc]="p.disconnected">
                <span class="lb-rank">#{{ i + 1 }}</span>
                <div class="lb-info">
                    <span class="lb-name">{{ p.username }}</span>
                    <span class="lb-score">{{ p.score }} pts</span>
                </div>
            </div>
            }
        </div>
    </aside>

    <!-- Ar√®ne Principale -->
    <main class="main-arena">
        <!-- Rail Sup√©rieur : Adversaires -->
        <section class="opponents-rail">
            @for (player of allOpponents(); track player.oderId) {
            <div class="opponent-card" [class.playing]="isCurrentPlayer(player.oderId)"
                [class.disconnected]="player.disconnected">
                <!-- Nom du joueur au-dessus -->
                <div class="opp-header">
                    <span class="opp-name">{{ player.username }}</span>
                    <span class="opp-score-badge">{{ calculatePlayerScore(player) }} pts</span>
                </div>
                <!-- Grille plus grande -->
                <div class="opp-grid-mini" [class.greyed]="player.disconnected">
                    @for (col of player.grid; track $index) {
                    <div class="mini-col" [class.eliminated]="col.length === 0">
                        @if (col.length > 0) {
                        @for (card of col; track card.id) {
                        <div class="mini-card" [class.revealed]="card.isRevealed"
                            [class]="card.isRevealed ? getCardColorClass(card.value) : ''">
                            @if (card.isRevealed) { {{ card.value }} }
                        </div>
                        }
                        } @else {
                        <!-- Colonne √©limin√©e : 3 cartes X gris√©es -->
                        <div class="mini-card eliminated-card">‚úï</div>
                        <div class="mini-card eliminated-card">‚úï</div>
                        <div class="mini-card eliminated-card">‚úï</div>
                        }
                    </div>
                    }
                </div>
            </div>
            }
        </section>

        <!-- Champ Central : Action & Joueur -->
        <section class="center-field">

            <!-- Zone Piles et Main (Left Side) -->
            <div class="piles-and-hand">
                <!-- Piles Column -->
                <div class="piles-zone">
                    <!-- Pioche -->
                    <div class="pile-group">
                        <div class="pile-label">Pioche</div>
                        <div class="pile draw" [class.active]="canDrawFromDeck()" (click)="drawFromDeck()">
                            <div class="card-back-stack"></div>
                            <span class="pile-count">{{ socketService.gameState()?.drawPile?.length }}</span>
                        </div>
                    </div>

                    <!-- D√©fausse -->
                    <div class="pile-group">
                        <div class="pile-label">D√©fausse</div>
                        <div class="pile discard" [class.active]="canDrawFromDiscard()" (click)="drawFromDiscard()">
                            @if (topDiscard(); as card) {
                            <div class="big-card discard-top" [class]="getCardColorClass(card.value)">
                                <span class="card-val">{{ card.value }}</span>
                            </div>
                            } @else {
                            <div class="empty-slot">Vide</div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Zone permanente pour la carte en main (√©vite le d√©calage) -->
                <div class="hand-slot">
                    @if (socketService.drawnCard(); as card) {
                    <div class="hand-transit animate-pop">
                        <div class="big-card" [class]="getCardColorClass(card.value)">
                            <span class="card-val">{{ card.value }}</span>
                        </div>
                        <button class="btn-action discard" (click)="discardDrawn()">D√©fausser</button>
                    </div>
                    }
                </div>
            </div>

            <!-- Zone Joueur (Center) -->
            <div class="player-zone" [class.my-turn]="isMyTurn()">
                <!-- Wrapper pour grille + HUD (sera centr√© avec status bar) -->
                <div class="board-and-hud">
                    <!-- Grille Joueur -->
                    <div class="player-grid">
                        @for (col of myPlayerState()?.grid || []; track $index; let colIdx = $index) {
                        <div class="grid-col" [class.eliminated]="col.length === 0">
                            @if (col.length === 0) {
                            <!-- Colonne √©limin√©e : 3 cartes X gris√©es -->
                            <div class="game-card eliminated-card"><span class="card-num">‚úï</span></div>
                            <div class="game-card eliminated-card"><span class="card-num">‚úï</span></div>
                            <div class="game-card eliminated-card"><span class="card-num">‚úï</span></div>
                            } @else {
                            @for (card of col; track card.id; let rowIdx = $index) {
                            <button class="game-card" [class.revealed]="card.isRevealed"
                                [class.clickable]="canClickCard(colIdx, rowIdx)"
                                [class.selecting]="isSelectingInitial() && !card.isRevealed"
                                [class.selected]="isCardSelected(colIdx, rowIdx)"
                                [class]="card.isRevealed ? getCardColorClass(card.value) : ''"
                                [disabled]="!canClickCard(colIdx, rowIdx)" (click)="onCardClick(colIdx, rowIdx)">
                                @if (card.isRevealed) {
                                <span class="card-num">{{ card.value }}</span>
                                } @else {
                                <div class="card-back-pattern"></div>
                                }
                            </button>
                            }
                            }
                        </div>
                        }
                    </div>

                    <!-- HUD √† droite -->
                    <div class="player-hud">
                        <div class="hud-identity">
                            <span class="hud-name">Moi</span>
                            @if(isMyTurn()){
                            <span class="turn-badge">Ton Tour</span>
                            }
                        </div>
                        <div class="hud-score">
                            <div class="score-val">{{ myCurrentScore() }}</div>
                            <span class="score-label">Cette Manche</span>
                        </div>
                    </div>
                </div>

                <!-- Game Status Bar (align√© avec le centre du board-and-hud) -->
                <div class="status-banner" [class.urgent]="phase() === 'lastTurn'">
                    <span class="round-indicator">Manche {{ socketService.gameState()?.roundNumber }}</span>
                    <span class="status-message">
                        @if (phase() === 'setup') {
                        Retourne 2 cartes pour commencer
                        } @else if (phase() === 'lastTurn') {
                        üö® DERNIER TOUR üö®
                        } @else {
                        @if (isMyTurn()) {
                        @if (mustRevealCard()) {
                        R√©v√®le une carte
                        } @else if (socketService.drawnCard()) {
                        Place ta carte OU D√©fause
                        } @else {
                        Pioche une carte ou prends la d√©fausse
                        }
                        } @else {
                        Au tour de {{ currentPlayerName() }}...
                        }
                        }
                    </span>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals (Overlay) -->

    <!-- Banni√®re Fin de Manche (flottante, ne bloque pas la vue) -->
    @if (socketService.gameState()?.phase === 'roundEnd' && !socketService.gameEndWinner()) {
    <div class="round-end-banner">
        <div class="banner-content">
            <div class="banner-header">
                <span class="banner-title">üèÅ Manche {{ socketService.roundEndData()?.finishedRoundNumber ||
                    socketService.gameState()?.roundNumber }} termin√©e !</span>
            </div>

            <!-- Scores compacts -->
            <div class="banner-scores">
                @for (s of sortedScores(); track s.playerId) {
                <div class="score-chip" [class.me]="s.playerId === socketService.currentPlayer()?.id">
                    <span class="chip-name">{{ getPlayerName(s.playerId) }}</span>
                    <span class="chip-pts">+{{ s.roundScore }}</span>
                </div>
                }
            </div>

            <!-- Statut pr√™t des joueurs -->
            <div class="ready-status">
                @for (p of socketService.gameState()?.players; track p.oderId) {
                <span class="ready-dot" [class.ready]="isPlayerReady(p.oderId)"
                    [class.me]="p.oderId === socketService.currentPlayer()?.id"
                    [title]="p.username + (isPlayerReady(p.oderId) ? ' ‚úì' : ' ...')">
                    {{ isPlayerReady(p.oderId) ? '‚úì' : '‚óã' }}
                </span>
                }
                <span class="ready-count">{{ readyCount() }}/{{ socketService.gameState()?.players?.length }}
                    pr√™ts</span>
            </div>

            <!-- Bouton Pr√™t -->
            @if (!isCurrentPlayerReady()) {
            <button class="btn-ready" (click)="setReadyForNextRound()">
                ‚úì Pr√™t pour la suite
            </button>
            } @else {
            <div class="waiting-text">En attente des autres joueurs...</div>
            }
        </div>
    </div>
    }

    <!-- Modal Fin de Jeu avec Podium -->
    @if (socketService.gameEndWinner(); as w) {
    @if (showGameEndModal()) {
    <div class="modal-overlay">
        <div class="modal-box game-over">
            <div class="game-over-header">
                <h2>üèÜ Partie Termin√©e !</h2>
                <p class="game-rules">
                    Un joueur a atteint 100 points.<br>
                    <strong>Le score le plus bas gagne !</strong>
                </p>
            </div>

            <!-- Podium visuel 2-1-3 -->
            <div class="podium-container">
                <!-- 2√®me place (gauche) -->
                @if (sortedPlayers()[1]; as second) {
                <div class="podium-slot second">
                    <span class="podium-medal">ü•à</span>
                    <span class="podium-name">{{ second.username }}</span>
                    <div class="podium-block">
                        <span class="podium-score">{{ second.score }} pts</span>
                    </div>
                </div>
                }

                <!-- 1√®re place (centre) -->
                @if (sortedPlayers()[0]; as first) {
                <div class="podium-slot first">
                    <span class="podium-medal crown">üëë</span>
                    <span class="podium-name">{{ first.username }}</span>
                    <div class="podium-block">
                        <span class="podium-score">{{ first.score }} pts</span>
                    </div>
                </div>
                }

                <!-- 3√®me place (droite) -->
                @if (sortedPlayers()[2]; as third) {
                <div class="podium-slot third">
                    <span class="podium-medal">ü•â</span>
                    <span class="podium-name">{{ third.username }}</span>
                    <div class="podium-block">
                        <span class="podium-score">{{ third.score }} pts</span>
                    </div>
                </div>
                }
            </div>

            <!-- Classement des autres joueurs (4√®me et +) -->
            @if (sortedPlayers().length > 3) {
            <div class="other-rankings">
                @for (p of sortedPlayers().slice(3); track p.oderId; let i = $index) {
                <div class="other-rank-row" [class.me]="p.oderId === socketService.currentPlayer()?.id">
                    <span class="other-rank-pos">#{{ i + 4 }}</span>
                    <span class="other-rank-name">{{ p.username }}</span>
                    <span class="other-rank-score">{{ p.score }} pts</span>
                </div>
                }
            </div>
            }

            <div class="modal-actions">
                <button class="btn-secondary" (click)="showGameEndModal.set(false)">üëÅÔ∏è Voir les plateaux</button>
                <button class="btn-primary" (click)="returnToHub()">Retour au Hub</button>
            </div>
        </div>
    </div>
    } @else {
    <!-- Bouton flottant pour r√©-afficher le modal -->
    <button class="floating-results-btn" (click)="showGameEndModal.set(true)">
        üèÜ Afficher les r√©sultats
    </button>
    }
    }
</div>

<!-- Contr√¥les flottants (Quitter + Th√®me) -->
<div class="floating-controls">
    <app-theme-toggle />
    <app-quit-button (confirmed)="quitGame()" />
</div>